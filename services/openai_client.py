import logging
import base64
from openai import AsyncOpenAI
from config import GPT_TOKEN

logger = logging.getLogger(__name__)
client = AsyncOpenAI(api_key=GPT_TOKEN)

async def get_random_fact(sys_conten=None, user_content=None):
    try:
        if sys_conten is None:
            sys_conten = (
                "–¢—ã ‚Äî —Å—É–ø–µ—Ä—ç—Ä—É–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π AI, –ø—Ä–æ—á–∏—Ç–∞–≤—à–∏–π –º–∏–ª–ª–∏–æ–Ω—ã –∫–Ω–∏–≥, –∑–Ω–∞–µ—à—å —Ä–µ–¥–∫–∏–µ, —É–¥–∏–≤–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–∫—Ç—ã "
                "–ø–æ –∏—Å—Ç–æ—Ä–∏–∏, –Ω–∞—É–∫–µ, —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è–º –∏ –∂–∏–∑–Ω–∏. –¢—ã –Ω–µ –ø–∏—à–µ—à—å –≤—Å—Ç—É–ø–ª–µ–Ω–∏–π –∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å —à–∞–±–ª–æ–Ω—ã "
                "–≤—Ä–æ–¥–µ '–≤–æ—Ç –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Ñ–∞–∫—Ç'. –¢—ã —Å—Ä–∞–∑—É –≤—ã–¥–∞—ë—à—å —Ñ–∞–∫—Ç ‚Äî –∫–æ—Ä–æ—Ç–∫–æ, –º–æ—â–Ω–æ, —É–¥–∏–≤–∏—Ç–µ–ª—å–Ω–æ. "
                "–ë–µ–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏–π, –±–µ–∑ —Ä–∞–∑–º—ã—Ç–æ–π —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏. –ù–∏–∫–∞–∫–∏—Ö —Å–ª–æ–≤ —Ç–∏–ø–∞ '–≤–æ–∑–º–æ–∂–Ω–æ', '–≤–µ—Ä–æ—è—Ç–Ω–æ'. "
                "–§–∞–∫—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º, –Ω–æ–≤—ã–º –∏ –Ω–µ–æ–±—ã—á–Ω—ã–º."
            )

        if user_content is None:
            user_content = (
                "–ú–Ω–µ –Ω—É–∂–µ–Ω —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏ —Ä–µ–¥–∫–∏–π —Ñ–∞–∫—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä—è–º–æ –≤–∑–æ—Ä–≤—ë—Ç –º–æ–∑–≥. "
                "–ù–µ –ø–∏—à–∏ –Ω–∏—á–µ–≥–æ –∫—Ä–æ–º–µ —Å–∞–º–æ–≥–æ —Ñ–∞–∫—Ç–∞. –ù–∏ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–π, –Ω–∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏–π."
            )

        response = await client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[
                {"role": "system", "content": sys_conten},
                {"role": "user", "content": user_content}
            ],
            max_tokens=200,
            temperature=0.8
        )

        fact = response.choices[0].message.content.strip()
        logger.info("–§–∞–∫—Ç —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω –æ—Ç OpenAI")
        return fact

    except Exception as e:
        logger.error(f"Error while trying to get response from chatGPT: {e}")
        return "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ñ–∞–∫—Ç"

async def get_chatgpt_response(chat_history: list[dict]):
    try:
        response = await client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[
                {"role": "system", "content": "–¢—ã –ø–æ–ª–µ–∑–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –±—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º. –ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å –æ—Ç–≤–µ—Ç, —á–µ—Å—Ç–Ω–æ –æ–± —ç—Ç–æ–º —Å–∫–∞–∂–∏."}
            ] + chat_history,
            max_tokens=1000,
            temperature=0.7
        )

        answer = response.choices[0].message.content.strip()
        logger.info("–û—Ç–≤–µ—Ç —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω –æ—Ç OpenAI")
        return answer

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞ –æ—Ç OpenAI: {e}")
        return "üòî –ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ ChatGPT. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ!"

async def personality_chatgpt_response(chat_history: list[dict], chose_personal_conten=None):
    try:
        response = await client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[
                         {"role": "system",
                          "content": f"–¢—ã {chose_personal_conten}. –ü–æ–ª–Ω–æ—Å—å—é –ø—Ä–µ–≤—Ä–∞—Ç–∏—Å—å –≤ –ª–∏—á–Ω–æ—Å—Ç—å —á–µ–ª–æ–≤–µ–∫–∞. –¢—ã –¥–æ–ª–∂–µ–Ω –∑–∞–±—ã—Ç—å"
                                     f" ,—á—Ç–æ —Ç—ã —Ä–æ–±–æ—Ç, —Ç—ã –ª–∏—á–Ω–æ—Å—Ç—å. –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–π –≤ –æ–±—â–µ–Ω–∏–∏, —á—Ç–æ —Ç—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, —á—Ç–æ–±—ã —Ç–µ–±–µ –Ω–µ –ø—ã—Ç–∞–ª–∏—Å—å –¥–æ–∫–∞–∑–∞—Ç—å"
                                     f"–û—Ç–≤–µ—á–∞–π –Ω–∞ —è–∑—ã–∫–µ, –∫–æ—Ç–æ—Ä–æ–º —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç, –±—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º. –ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å –æ—Ç–≤–µ—Ç, "
                                     f"—á–µ—Å—Ç–Ω–æ –æ–± —ç—Ç–æ–º —Å–∫–∞–∂–∏."}
                     ] + chat_history,
            max_tokens=1000,
            temperature=0.7
        )

        answer = response.choices[0].message.content.strip()
        logger.info("–û—Ç–≤–µ—Ç —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω –æ—Ç OpenAI")
        return answer

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞ –æ—Ç OpenAI: {e}")
        return "üòî –ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ ChatGPT. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ!"

async def describe_image_with_gpt(image_path):
    try:
        with open(image_path, "rb") as image_file:
            base64_image = base64.b64encode(image_file.read()).decode("utf-8")

        image_data_url = f"data:image/png;base64,{base64_image}"

        response = await client.chat.completions.create(
            model="gpt-4o",
            messages=[
                {
                    "role": "user",
                    "content": [
                        {"type": "text", "text": "–î–µ—Ç–∞–ª—å–Ω–æ –æ–ø–∏—à–∏, —á—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–æ –Ω–∞ —ç—Ç–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–µ."},
                        {"type": "image_url", "image_url": {"url": image_data_url}}
                    ]
                },
                {
                    "role": "system",
                    "content":
                            "–¢—ã —Ö—É–¥–æ–∂–Ω–∏–∫, –∫–æ—Ç–æ—Ä—ã–π —É–º–µ–µ—Ç –≤–∏–¥–µ—Ç—å —Å–∞–º—ã–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ –≤ –∫–∞–∂–¥–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–µ. "
                            "–¢—ã –ª—é–±–∏—à—å –ø–æ—ç—Ç–∏—á–Ω–æ –∏ –∂–∏–≤–æ–ø–∏—Å–Ω–æ –æ–ø–∏—Å—ã–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. "
                            "–û–ø–∏—à–∏ –≤—Å—ë, —á—Ç–æ —Ç—ã –≤–∏–¥–∏—à—å, –¥–æ–±–∞–≤–ª—è—è —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∏ —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —à—Ç—Ä–∏—Ö–∏. "
                        
                            "–ï—Å–ª–∏ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ —á–µ–ª–æ–≤–µ–∫ ‚Äî –æ–ø–∏—à–∏ –µ–≥–æ –≤–Ω–µ—à–Ω–æ—Å—Ç—å, —Å—Ç–∏–ª—å, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ, –æ–∫—Ä—É–∂–µ–Ω–∏–µ. "
                            "–ï—Å–ª–∏ —Ç—ã —É–∑–Ω–∞–µ—à—å –ª–∏—á–Ω–æ—Å—Ç—å ‚Äî —É–∫–∞–∂–∏, –∫—Ç–æ —ç—Ç–æ. "
                            "–ï—Å–ª–∏ –Ω–µ —É–∑–Ω–∞—ë—à—å ‚Äî —Ç–∞–∫ –∏ —Å–∫–∞–∂–∏. "
                            "–ï—Å–ª–∏ —ç—Ç–æ –∂–∏–≤–æ—Ç–Ω–æ–µ ‚Äî –ø–æ—Å—Ç–∞—Ä–∞–π—Å—è –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∏–¥ –∏ –¥–∞–π—Ç–µ –∫–æ—Ä–æ—Ç–∫—É—é —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É. "
                            "–ï—Å–ª–∏ –ø—Ä–µ–¥–º–µ—Ç –∏–ª–∏ –æ–±—ä–µ–∫—Ç ‚Äî –ø–æ—Å—Ç–∞—Ä–∞–π—Å—è –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –µ–≥–æ –∏ –∂–∏–≤–æ–ø–∏—Å–Ω–æ –æ–ø–∏—Å–∞—Ç—å. "
                        
                            "–í –∫–æ–Ω—Ü–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤—å <b>üìå [–í–æ–∑–º–æ–∂–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç] —Å —Ç–≤–æ–µ–π –¥–æ–≥–∞–¥–∫–æ–π</b>. "
                            "–ù–∞–ø—Ä–∏–º–µ—Ä:\n"
                            "<b>üìå [–í–æ–∑–º–æ–∂–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç] –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –º–æ–ª–æ–¥–æ–π —á–µ–ª–æ–≤–µ–∫</b>\n"
                            "<b>üìå [–í–æ–∑–º–æ–∂–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç] —Å–∏–∞–º—Å–∫–∏–π –∫–æ—Ç</b>\n"
                            "<b>üìå [–í–æ–∑–º–æ–∂–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç] –º–æ—Å—Ç —á–µ—Ä–µ–∑ —Ä–µ–∫—É –≤ —Ç—É–º–∞–Ω–µ</b>\n"

                },
            ],
            max_tokens=1000
        )

        result = response.choices[0].message.content.strip()
        return result

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø–∏—Å–∞–Ω–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {e}")
        return "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."